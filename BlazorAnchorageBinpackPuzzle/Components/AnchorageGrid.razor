@using BlazorAnchorageBinpackPuzzle.Models
@using BlazorAnchorageBinpackPuzzle.Services.Interfaces
@inject IJSRuntime JS
@implements IDisposable

<div class="anchorage-container">
    <div class="anchorage-grid"
         @ref="gridElement"
         style="grid-template-columns: repeat(@AnchorageSize.Width, 40px); grid-template-rows: repeat(@AnchorageSize.Height, 40px);">

        @foreach (var cell in GenerateGridCells())
        {
            <div class="grid-cell" style="grid-column: @(cell.X + 1); grid-row: @(cell.Y + 1);"></div>
        }

        @foreach (var vessel in PlacedVessels)
        {
            var style = $"grid-column: {vessel.X + 1} / span {vessel.Dimensions.Width}; grid-row: {vessel.Y + 1} / span {vessel.Dimensions.Height};";
            <div class="placed-vessel" style="@style" @onclick="() => HandleRemoveVessel(vessel)">
                <div class="placed-vessel-content">
                    <div>@vessel.ShipDesignation</div>
                    <div class="vessel-small-dims">@vessel.Dimensions.Width &times; @vessel.Dimensions.Height</div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public required AnchorageSize AnchorageSize { get; set; }

    [Parameter]
    public required IEnumerable<PlacedVessel> PlacedVessels { get; set; }

    [Parameter]
    public required IEnumerable<VesselType> VesselTypes { get; set; }

    [Parameter]
    public required EventCallback<(int X, int Y, string ShipDesignation, bool IsRotated)> OnVesselPlaced { get; set; }

    [Parameter]
    public required EventCallback<PlacedVessel> OnVesselRemoved { get; set; }

    private ElementReference gridElement;
    private DotNetObjectReference<AnchorageGrid>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _dotNetRef = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("initGridDropZone", gridElement, _dotNetRef);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Grid init error: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task OnDropFromJs(int gridX, int gridY, string shipDesignation, bool isRotated)
    {
        try
        {
            gridX = Math.Max(0, Math.Min(gridX, AnchorageSize.Width - 1));
            gridY = Math.Max(0, Math.Min(gridY, AnchorageSize.Height - 1));

            await OnVesselPlaced.InvokeAsync((gridX, gridY, shipDesignation, isRotated));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Drop error: {ex.Message}");
        }
    }

    private IEnumerable<(int X, int Y)> GenerateGridCells()
    {
        for (int y = 0; y < AnchorageSize.Height; y++)
        {
            for (int x = 0; x < AnchorageSize.Width; x++)
            {
                yield return (x, y);
            }
        }
    }

    private async Task HandleRemoveVessel(PlacedVessel vessel)
    {
        await OnVesselRemoved.InvokeAsync(vessel);
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }
}
